<!--pages/mine/index.wxml-->
<view class="container">
  <!-- 未登录时显示登录提示卡片 -->
  <view wx:if="{{!isLoggedIn}}">
    <!-- 用户信息卡片 -->
    <view class="profile-card card-gradient">
      <view class="role-badge-top" wx:if="{{userInfo.role}}">{{userInfo.role === 'admin' || userInfo.role === 'boss' ? '管理员' : '员工'}}</view>
      <view class="profile-content">
        <view class="profile-avatar" bindtap="showLoginModal">
          <image class="avatar-image" src="{{userInfo.avatarUrl}}" mode="aspectFill" wx:if="{{userInfo && userInfo.avatarUrl}}"></image>
          <text class="avatar-text" wx:else>{{avatarText}}</text>
        </view>
        <view class="profile-info">
          <text class="user-name">{{userInfo.name || userInfo.nickName || '微信用户'}}</text>
          <view class="profile-details">
            <view class="detail-item" wx:if="{{tenantInfo.name}}">
              <image class="detail-icon" src="/images/icons/user.svg" mode="aspectFit"></image>
              <text class="detail-text">{{tenantInfo.name}}</text>
            </view>
          </view>
          <text class="user-phone" wx:if="{{userInfo.phone}}">{{userInfo.phone}}</text>
        </view>
      </view>
    </view>

    <!-- 基础管理 (未登录可见部分，通常只有登录后可见，这里修正逻辑) -->
    <view class="section">
      <text class="section-title">基础管理</text>
      <view class="menu-card card">
        <block wx:for="{{menuItems}}" wx:key="id">
          <view 
            class="menu-item" 
            bindtap="onMenuItemTap"
            data-path="{{item.path}}"
            wx:if="{{!item.adminOnly || (item.adminOnly && (userInfo.role === 'admin' || userInfo.role === 'boss'))}}"
          >
            <view class="menu-icon-wrapper" style="background: {{item.bgColor}};">
              <image class="menu-icon" src="{{item.icon}}" mode="aspectFit"></image>
            </view>
            <view class="menu-content">
              <text class="menu-title">{{item.title}}</text>
              <text class="menu-desc">{{item.desc}}</text>
            </view>
            <text class="menu-arrow">›</text>
          </view>
        </block>
      </view>
    </view>

    <!-- 版本信息 -->
    <view class="version-info">
      <text>版本 v1.1.6</text>
    </view>
  </view>

  <!-- 登录弹窗 -->
  <view class="login-modal" wx:if="{{showLogin}}" bindtap="hideLoginModal" catchtouchmove="true">
    <view class="login-modal-content" catchtap="stopPropagation">
      <!-- 标题区域 -->
      <view class="login-modal-header">
        <text class="login-modal-title">申请获取以下权限</text>
        <text class="login-modal-subtitle">纱线加工管理小程序</text>
      </view>
      
      <!-- 表单区域 -->
      <view class="login-form-section" catchtap="onFormSectionClick">
        <!-- 头像（放在最上面） -->
        <view class="avatar-section-top">
          <view class="avatar-wrapper-top">
            <button class="avatar-btn-top" open-type="chooseAvatar" bindchooseavatar="onChooseAvatar">
              <image class="avatar-img-top" src="{{avatarUrl}}" mode="aspectFill" wx:if="{{avatarUrl}}"></image>
              <view class="avatar-placeholder-top" wx:else></view>
            </button>
          </view>
          <text class="avatar-label-top">点击选择头像</text>
        </view>
        
        <!-- 昵称 -->
        <view class="form-item">
          <view class="form-item-content">
            <text class="form-item-label">昵称 *</text>
            <input 
              class="form-input" 
              type="nickname" 
              placeholder="请输入或获取昵称"
              value="{{nickName}}"
              bindinput="onNickNameInput"
              bindblur="onNickNameInput"
              bindchange="onNickNameInput"
              maxlength="20"
            />
          </view>
        </view>
        
        <!-- 手机号 -->
        <view class="form-item">
          <view class="form-item-content">
            <text class="form-item-label">手机号 *</text>
            <view class="phone-input-container">
              <input 
                class="form-input phone-input-field" 
                type="number"
                placeholder="请输入手机号"
                value="{{phoneNumber}}"
                bindinput="onPhoneInput"
                bindblur="onPhoneInput"
                maxlength="11"
              />
              <button 
                class="get-phone-link" 
                open-type="getPhoneNumber"
                bindgetphonenumber="onGetPhoneNumber"
                wx:if="{{!phoneNumber}}"
              >
                获取
              </button>
              <text class="phone-success-tag" wx:else>已填</text>
            </view>
          </view>
        </view>
        
        <!-- 提示文本 -->
        <text class="form-tip">授权后，该小程序将获取你的昵称、头像等信息</text>
      </view>
      
      <!-- 底部按钮 -->
      <view class="login-modal-footer">
        <button class="cancel-btn" bindtap="hideLoginModal">取消</button>
        <button 
          class="allow-btn" 
          bindtap="handleWeChatLogin"
          loading="{{loading}}"
        >
          确定
        </button>
      </view>
    </view>
  </view>

  <!-- 已登录时显示用户信息 -->
  <view wx:if="{{isLoggedIn}}">
    <!-- 用户信息卡片 -->
    <view class="profile-card card-gradient">
      <view class="role-badge-top" wx:if="{{userInfo.role}}">{{userInfo.role === 'admin' || userInfo.role === 'boss' ? '管理员' : '员工'}}</view>
      <view class="profile-content">
        <view class="profile-avatar" bindtap="showLoginModal">
          <image class="avatar-image" src="{{userInfo.avatarUrl}}" mode="aspectFill" wx:if="{{userInfo && userInfo.avatarUrl}}"></image>
          <text class="avatar-text" wx:else>{{avatarText}}</text>
        </view>
        <view class="profile-info">
          <text class="user-name">{{userInfo.name || userInfo.nickName || '微信用户'}}</text>
          <view class="profile-details">
            <view class="detail-item" wx:if="{{tenantInfo.name}}">
              <image class="detail-icon" src="/images/icons/user.svg" mode="aspectFit"></image>
              <text class="detail-text">{{tenantInfo.name}}</text>
            </view>
          </view>
          <text class="user-phone" wx:if="{{userInfo.phone}}">{{userInfo.phone}}</text>
        </view>
      </view>
    </view>

    <!-- 基础管理 (未登录可见部分，通常只有登录后可见，这里修正逻辑) -->
    <view class="section">
      <text class="section-title">基础管理</text>
      <view class="menu-card card">
        <block wx:for="{{menuItems}}" wx:key="id">
          <view 
            class="menu-item" 
            bindtap="onMenuItemTap"
            data-path="{{item.path}}"
            wx:if="{{!item.adminOnly || (item.adminOnly && (userInfo.role === 'admin' || userInfo.role === 'boss'))}}"
          >
            <view class="menu-icon-wrapper" style="background: {{item.bgColor}};">
              <image class="menu-icon" src="{{item.icon}}" mode="aspectFit"></image>
            </view>
            <view class="menu-content">
              <text class="menu-title">{{item.title}}</text>
              <text class="menu-desc">{{item.desc}}</text>
            </view>
            <text class="menu-arrow">›</text>
          </view>
        </block>
      </view>
    </view>

    <!-- 版本信息 -->
    <view class="version-info">
      <text>版本 v1.1.6</text>
    </view>
  </view>
</view>

