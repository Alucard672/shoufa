<!--pages/statistics/index.wxml-->
<view class="design-page">
  <!-- 页面标题 -->
  <view class="page-header">
    <text class="page-title">交货表统计</text>
    <text class="page-subtitle">发料与回货对照表</text>
  </view>

  <!-- 顶部统计卡：一排三个（按你的要求做小一点） -->
  <view class="stats-grid">
    <view class="stats-card stats-blue" bindtap="onTotalIssueClick">
      <text class="stats-label">总发料单数</text>
      <view class="stats-value-row">
        <text class="stats-value">{{totalIssueCount}}</text>
        <text class="stats-unit">笔</text>
      </view>
    </view>

    <view class="stats-card stats-green" bindtap="onReturnedIssueClick">
      <text class="stats-label">已回货单数</text>
      <view class="stats-value-row">
        <text class="stats-value">{{returnedCount}}</text>
        <text class="stats-unit">笔</text>
      </view>
    </view>

    <view class="stats-card stats-green-2" bindtap="onTotalReturnClick">
      <text class="stats-label">累计回货件数</text>
      <view class="stats-value-row">
        <text class="stats-value">{{totalReturnPieces}}</text>
        <text class="stats-unit">件</text>
      </view>
    </view>

    <view class="stats-card stats-orange" bindtap="onTotalReturnClick">
      <text class="stats-label">累计回货重量</text>
      <view class="stats-value-row">
        <text class="stats-value">{{totalReturnWeightFormatted}}</text>
        <text class="stats-unit">kg</text>
      </view>
    </view>

    <view class="stats-card stats-purple" bindtap="onStyleStatsClick">
      <text class="stats-label">按款号统计</text>
      <view class="stats-value-row">
        <text class="stats-value">{{styleCount}}</text>
        <text class="stats-unit">款</text>
      </view>
    </view>

    <view class="stats-card stats-teal" bindtap="onFactoryStatsClick">
      <text class="stats-label">按加工厂统计</text>
      <view class="stats-value-row">
        <text class="stats-value">{{factoryCount}}</text>
        <text class="stats-unit">家</text>
      </view>
    </view>
  </view>

  <!-- 时间筛选（按 Figma：黑底选中、8px圆角） -->
  <view class="seg-row">
    <view class="seg-btn {{timeFilter === 'all' ? 'is-active' : ''}}" data-index="0" bindtap="onTimeSegTap">全部时间</view>
    <view class="seg-btn {{timeFilter === 'today' ? 'is-active' : ''}}" data-index="1" bindtap="onTimeSegTap">今天</view>
    <view class="seg-btn {{timeFilter === 'week' ? 'is-active' : ''}}" data-index="2" bindtap="onTimeSegTap">本周</view>
    <view class="seg-btn {{timeFilter === 'month' ? 'is-active' : ''}}" data-index="3" bindtap="onTimeSegTap">本月</view>
  </view>

  <!-- 状态筛选（按 Figma） -->
  <view class="seg-row">
    <view class="seg-btn {{statusFilter === 'all' ? 'is-active' : ''}}" data-index="0" bindtap="onStatusSegTap">全部 ({{totalIssueCount}})</view>
    <view class="seg-btn {{statusFilter === '未回货' ? 'is-active' : ''}}" data-index="1" bindtap="onStatusSegTap">未回货</view>
    <view class="seg-btn {{statusFilter === '部分回货' ? 'is-active' : ''}}" data-index="2" bindtap="onStatusSegTap">部分回货</view>
    <view class="seg-btn {{statusFilter === '已回货' ? 'is-active' : ''}}" data-index="3" bindtap="onStatusSegTap">已回货</view>
  </view>

  <!-- 搜索框（按 Figma：灰底、8px圆角） -->
  <view class="search-wrap">
    <input
      class="search-input"
      placeholder="搜索发料单号或款号..."
      value="{{searchKeyword}}"
      bindinput="onSearch"
      bindconfirm="onSearch"
    />
  </view>

  <!-- 统计列表 -->
  <view class="statistics-list">
    <view class="stat-card stat-card-{{item.status === '未回货' ? 'warn' : (item.status === '部分回货' ? 'info' : 'ok')}}" wx:for="{{statistics}}" wx:key="_id">
      <view class="stat-head">
        <text class="stat-no">{{item.issueNo}}</text>
        <badge type="{{item.status === '未回货' ? 'warning' : item.status === '部分回货' ? 'info' : 'success'}}" text="{{item.status}}" />
      </view>
      <view class="stat-style-line">
        <text class="style-line-text">{{item.styleCode || ''}}<text wx:if="{{item.styleCode}}"> - </text>{{item.styleName || '未知款号'}}</text>
        <text class="style-line-meta" wx:if="{{item.yarnUsagePerPiece > 0}}">· {{item.yarnUsagePerPiece}}g/件</text>
      </view>
      
      <view class="stat-issue">
        <view class="stat-row">
          <text class="stat-label">发料日期</text>
          <text class="stat-value">{{item.issueDateFormatted}}</text>
        </view>
        <view class="stat-row">
          <text class="stat-label">发料重量</text>
          <text class="stat-value weight">{{item.issueWeightFormatted}}</text>
        </view>
      </view>
      
      <view class="stat-return" wx:if="{{item.status !== '未回货'}}">
        <view class="stat-row">
          <text class="stat-label">回货日期</text>
          <text class="stat-value">{{item.latestReturnDateFormatted}}</text>
        </view>
        <view class="stat-row">
          <text class="stat-label">回货重量</text>
          <text class="stat-value return">{{item.totalReturnYarnFormatted}}</text>
        </view>
        <view class="stat-row">
          <text class="stat-label">回货数量</text>
          <text class="stat-value">{{item.totalReturnPiecesFormatted}}</text>
        </view>
        <view class="stat-row" wx:if="{{item.totalReturnPieces > 0}}">
          <text class="stat-label">计划用纱</text>
          <text class="stat-value">{{item.planYarnUsageFormatted}}</text>
        </view>
        <view class="stat-row" wx:if="{{item.totalReturnPieces > 0}}">
          <text class="stat-label">实际用纱</text>
          <text class="stat-value">{{item.totalReturnYarnFormatted}}</text>
        </view>
        <view class="stat-row" wx:if="{{item.totalReturnPieces > 0 && item.lossAmount !== 0}}">
          <text class="stat-label">损耗量</text>
          <text class="stat-value {{item.lossAmount > 0 ? 'loss-positive' : 'loss-negative'}}">
            {{item.lossAmount > 0 ? '+' : ''}}{{item.lossAmountFormatted}}
          </text>
          <text class="stat-value loss-rate">({{item.actualLossRateFormatted}})</text>
        </view>
      </view>
      
      <view class="stat-remaining" wx:if="{{item.status === '部分回货'}}">
        <view class="remaining-row">
          <text class="remaining-label">剩余待回</text>
          <text class="remaining-value">{{item.remainingYarnFormatted}}</text>
          <text class="remaining-quantity">{{item.remainingPiecesFormatted}}</text>
        </view>
      </view>
      
      <view class="stat-waiting" wx:if="{{item.status === '未回货'}}">
        <text class="waiting-text">等待回货中...</text>
      </view>
      
      <view class="stat-return" wx:if="{{item.status === '未回货'}}">
        <view class="stat-row">
          <text class="stat-label">回货日期</text>
          <text class="stat-value">-</text>
        </view>
        <view class="stat-row">
          <text class="stat-label">回货重量</text>
          <text class="stat-value">-</text>
        </view>
        <view class="stat-row">
          <text class="stat-label">回货数量</text>
          <text class="stat-value">-</text>
        </view>
      </view>
      
      <view class="return-details" wx:if="{{item.returnOrders.length > 1}}">
        <text class="details-title">回货明细（{{item.returnOrders.length}}次）</text>
        <view class="details-list">
          <view class="detail-item" wx:for="{{item.returnOrders}}" wx:key="_id" wx:for-item="returnOrder">
            <view class="detail-header">
              <text class="detail-no">#{{returnOrder.returnOrderIndex}}</text>
              <text class="detail-date">{{returnOrder.returnDateFormatted}}</text>
            </view>
            <text class="detail-info">{{returnOrder.quantityFormatted}} · {{returnOrder.actualYarnUsageFormatted}}kg</text>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>

