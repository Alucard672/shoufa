<!--pages/statistics/factory-detail.wxml-->
<view class="page-wrapper">
  <!-- 顶部青色背景区域（对齐回货明细页） -->
  <view class="header-bg">
    <view class="header-content">
      <view class="header-icon-box">
        <text class="header-icon-text">厂</text>
      </view>
      <view class="header-text-group">
        <text class="header-title">{{factoryName || '工厂明细'}}</text>
        <text class="header-subtitle">发料/回货统计</text>
      </view>
    </view>
    <view class="header-time">
      <image class="time-icon" src="/images/icons/calendar.svg" mode="aspectFit" style="filter: brightness(0) invert(1);"></image>
      <text>统计周期: {{timeFilterLabel}}</text>
    </view>
  </view>

  <!-- 汇总统计网格 (3x2) -->
  <view class="summary-grid-section">
    <view class="summary-grid">
      <view class="grid-item">
        <image class="grid-icon" src="/images/icons/issue.svg" mode="aspectFit"></image>
        <text class="grid-label">发料单数</text>
        <text class="grid-value">{{summary.totalIssueCount || 0}}</text>
      </view>
      <view class="grid-item">
        <image class="grid-icon" src="/images/icons/issue.svg" mode="aspectFit"></image>
        <text class="grid-label">发料重量</text>
        <text class="grid-value">{{summary.totalIssueWeightFormatted || '0.00kg'}}</text>
      </view>
      <view class="grid-item">
        <image class="grid-icon" src="/images/icons/shirt.svg" mode="aspectFit"></image>
        <text class="grid-label">回货件数</text>
        <text class="grid-value">{{summary.totalReturnPiecesFormatted || '0打0件'}}</text>
      </view>
      <view class="grid-item">
        <image class="grid-icon" src="/images/icons/package.svg" mode="aspectFit"></image>
        <text class="grid-label">回货重量</text>
        <text class="grid-value">{{summary.totalReturnWeightFormatted || '0.00kg'}}</text>
      </view>
      <view class="grid-item">
        <image class="grid-icon" src="/images/icons/shirt.svg" mode="aspectFit"></image>
        <text class="grid-label">款号数</text>
        <text class="grid-value">{{summary.styleCount || 0}}</text>
      </view>
      <view class="grid-item">
        <image class="grid-icon" src="/images/icons/check.svg" mode="aspectFit"></image>
        <text class="grid-label">已回单数</text>
        <text class="grid-value highlight">{{summary.returnedIssueCount || 0}}</text>
      </view>
    </view>
  </view>

  <!-- 工厂信息卡片 -->
  <view class="section">
    <view class="card">
      <text class="muted-text">点击列表可进入发料单明细</text>
    </view>
  </view>

  <!-- 筛选卡片 -->
  <view class="section">
    <view class="card">
      <view class="filter-row">
        <text class="filter-label">款号</text>
        <input 
          class="filter-input" 
          type="text" 
          placeholder="请输入款号代码或名称"
          value="{{styleKeyword}}"
          bindinput="onStyleKeywordInput"
        />
      </view>
      <view class="filter-row">
        <text class="filter-label">日期</text>
        <view class="tabs-wrap">
          <filter-tabs 
            options="{{['全部时间', '今天', '本周', '本月']}}"
            current="{{timeFilter === 'all' ? 0 : timeFilter === 'today' ? 1 : timeFilter === 'week' ? 2 : 3}}"
            bindchange="onTimeFilterChange"
          />
        </view>
      </view>
    </view>
  </view>

  <!-- 明细列表 -->
  <view class="section">
    <view class="section-header">
      <text class="section-title">发料单明细</text>
    </view>
    <view class="order-list">
      <view class="card order-card" wx:for="{{filteredIssueOrders}}" wx:key="_id" bindtap="navigateToDetail" data-id="{{item._id}}">
        <view class="style-name-row" style="justify-content: space-between;">
          <text class="style-name">{{item.issueNo}}</text>
          <badge type="{{item.status === '未回货' ? 'warning' : item.status === '部分回货' ? 'info' : 'success'}}" text="{{item.status}}" />
        </view>

        <view class="style-name-row" style="margin-top: 10rpx;">
          <text class="style-code" wx:if="{{item.styleCode}}">[{{item.styleCode}}]</text>
          <text class="muted-text">{{item.styleName}}</text>
        </view>

        <view class="mini-grid">
          <view class="mini-item">
            <text class="mini-label">发料日期</text>
            <text class="mini-value">{{item.issueDateFormatted}}</text>
          </view>
          <view class="mini-item">
            <text class="mini-label">发料重量</text>
            <text class="mini-value">{{item.issueWeightFormatted}}</text>
          </view>
          <view class="mini-item">
            <text class="mini-label">回货件数</text>
            <text class="mini-value green">{{item.totalReturnPiecesFormatted}}</text>
          </view>
          <view class="mini-item">
            <text class="mini-label">回货重量</text>
            <text class="mini-value green">{{item.totalReturnWeightFormatted}}</text>
          </view>
          <view class="mini-item" wx:if="{{item.status === '部分回货'}}">
            <text class="mini-label">剩余待回</text>
            <text class="mini-value unpaid">{{item.remainingYarnFormatted}}</text>
          </view>
          <view class="mini-item">
            <text class="mini-label">最近回货</text>
            <text class="mini-value">{{item.latestReturnDateFormatted}}</text>
          </view>
        </view>
      </view>

      <view class="empty-tip" wx:if="{{filteredIssueOrders.length === 0}}">
        <text>暂无相关明细</text>
      </view>
    </view>
  </view>
</view>

