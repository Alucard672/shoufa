<!--pages/return/create.wxml-->
<view class="page-wrapper">
  <!-- 顶部青色背景区域（参考回货明细页） -->
  <view class="header-bg">
    <view class="header-content">
      <view class="header-icon-box">
        <text class="header-icon-text">回</text>
      </view>
      <view class="header-text-group">
        <text class="header-title">{{isEdit ? '编辑回货单' : (factory.name || '新建回货单')}}</text>
        <text class="header-subtitle">{{issueOrder ? ('发料单号: ' + (issueOrder.issueNo || issueOrder.issue_no || '-')) : '请从发料单进入回货登记'}}</text>
      </view>
    </view>
    <view class="header-time">
      <image class="time-icon" src="/images/icons/calendar.svg" mode="aspectFit" style="filter: brightness(0) invert(1);"></image>
      <text>回货日期: {{returnDate || '-'}}</text>
    </view>
  </view>

  <!-- 款式信息卡片（压住抬头背景） -->
  <view class="section style-top" wx:if="{{style}}">
    <view class="card style-card">
      <view class="style-info-row">
        <view class="style-image-container" catchtap="onPreviewImage" data-url="{{styleImageUrl}}">
          <image class="style-image" src="{{styleImageUrl}}" mode="aspectFill" wx:if="{{styleImageUrl}}" binderror="onStyleImageError"></image>
          <view class="style-image-placeholder" wx:else>
            <image class="placeholder-icon" src="/images/icons/camera.svg" mode="aspectFit"></image>
          </view>
        </view>
        <view class="style-text-content">
          <view class="style-name-row">
            <text class="style-code" wx:if="{{style.styleCode || style.style_code}}">[{{style.styleCode || style.style_code}}]</text>
            <text class="style-name">{{style.styleName || style.style_name || '未知款号'}}</text>
          </view>
          <view class="style-meta-row">
            <text class="meta-item" wx:if="{{issueOrder}}">发料重量: {{issueOrder.issueWeight || issueOrder.issue_weight || 0}} kg</text>
            <text class="meta-item" wx:if="{{style.yarnUsagePerPiece || style.yarn_usage_per_piece}}">单件用量: {{style.yarnUsagePerPiece || style.yarn_usage_per_piece}}g</text>
          </view>
        </view>
      </view>
      <view class="img-tip" wx:if="{{styleImageError}}">
        <text>图片加载失败，请检查款号图片是否为 cloud:// 文件ID</text>
      </view>
    </view>
  </view>

  <!-- 回货概览（沿用回货明细页的网格元素） -->
  <view class="summary-grid-section">
    <view class="summary-grid">
      <view class="grid-item">
        <image class="grid-icon" src="/images/icons/shirt.svg" mode="aspectFit"></image>
        <text class="grid-label">回货数量</text>
        <text class="grid-value">{{calculatedQuantityFormatted || '--'}}</text>
      </view>
      <view class="grid-item">
        <image class="grid-icon" src="/images/icons/package.svg" mode="aspectFit"></image>
        <text class="grid-label">预计用纱</text>
        <text class="grid-value">{{calculatedYarnUsageFormatted ? (calculatedYarnUsageFormatted + ' kg') : '--'}}</text>
      </view>
      <view class="grid-item">
        <image class="grid-icon" src="/images/icons/statistics.svg" mode="aspectFit"></image>
        <text class="grid-label">加工费合计</text>
        <text class="grid-value highlight">{{calculatedFeeFormatted ? ('¥' + calculatedFeeFormatted) : '--'}}</text>
      </view>
    </view>
  </view>

  <view class="section">
    <view class="card form-section">
    <view class="form-item">
      <text class="form-label">款号</text>
      <search-select 
        placeholder="请搜索选择款号（可选）"
        options="{{styles}}"
        display-key="styleName"
        value-key="_id"
        format-display="style"
        selected-values="{{selectedStyle ? [selectedStyle] : []}}"
        multiple="{{false}}"
        bindchange="onStyleChange"
      />
    </view>
    
    <view class="form-item">
      <text class="form-label">颜色 *</text>
      <search-select 
        placeholder="请选择颜色"
        options="{{colorOptions}}"
        display-key="name"
        value-key="_id"
        selected-values="{{selectedColors}}"
        multiple="{{false}}"
        bindchange="onColorChange"
      />
    </view>

    <view class="form-item">
      <text class="form-label">尺码</text>
      <search-select 
        placeholder="尺码(可选)"
        options="{{sizeOptions}}"
        display-key="name"
        value-key="_id"
        selected-values="{{selectedSizes}}"
        multiple="{{false}}"
        bindchange="onSizeChange"
      />
    </view>

    <view class="form-item">
      <text class="form-label">回货打数</text>
      <input 
        class="form-input" 
        type="number" 
        placeholder="请输入打数"
        value="{{returnDozens}}"
        bindinput="onDozensInput"
      />
    </view>

    <view class="form-item">
      <text class="form-label">零散件数</text>
      <input 
        class="form-input" 
        type="number" 
        placeholder="请输入件数"
        value="{{returnPieces}}"
        bindinput="onPiecesInput"
      />
    </view>

    <view class="form-item">
      <text class="form-label">回货日期</text>
      <picker mode="date" value="{{returnDate}}" bindchange="onDateChange">
        <view class="picker-box">
          {{returnDate || '请选择日期'}}
          <text class="arrow">›</text>
        </view>
      </picker>
    </view>

    <view class="form-item">
      <view class="switch-item">
        <text class="form-label">保存后分享</text>
        <switch checked="{{shareAfterSave}}" bindchange="onShareSwitchChange" color="#155DFC" />
      </view>
    </view>
    </view>
  </view>

  <view class="bottom-actions">
    <button class="btn-complete" wx:if="{{returnOrderId && status === '进行中'}}" bindtap="onMarkComplete">标记为完成</button>
    <button class="btn-submit" bindtap="onSubmit" disabled="{{submitting}}">{{isEdit ? '保存' : '确认提交回货单'}}</button>
  </view>

  <!-- 隐藏的画布用于生成分享图片 -->
  <canvas 
    canvas-id="shareCanvas" 
    style="position: fixed; top: -9999px; left: -9999px; width: 750px; height: 1200px;"
    disable-scroll="true"
  ></canvas>
</view>

