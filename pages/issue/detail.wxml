<!--pages/issue/detail.wxml-->
<view class="page-wrapper">
  <!-- 顶部橙色背景区域 -->
  <view class="header-bg">
    <view class="header-content">
      <view class="header-icon-box">
        <text class="header-icon-text">发</text>
      </view>
      <view class="header-text-group">
        <text class="header-title">{{issueOrder.factoryName || '加工厂'}}</text>
        <text class="header-subtitle">发料单号: {{issueOrder.issueNo || '-'}}</text>
      </view>
    </view>
    <view class="header-time">
      <image class="time-icon" src="/images/icons/calendar.svg" mode="aspectFit" style="filter: brightness(0) invert(1);"></image>
      <text>发料日期: {{issueOrder.issueDateFormatted || '-'}}</text>
    </view>
  </view>

  <!-- 汇总统计网格 (3x2) -->
  <view class="summary-grid-section">
    <view class="summary-grid">
      <view class="grid-item">
        <image class="grid-icon" src="/images/icons/issue.svg" mode="aspectFit"></image>
        <text class="grid-label">发料重量</text>
        <text class="grid-value">{{issueOrder.issueWeightFormatted}}</text>
      </view>
      <view class="grid-item">
        <image class="grid-icon" src="/images/icons/shirt.svg" mode="aspectFit"></image>
        <text class="grid-label">预计件数</text>
        <text class="grid-value">{{issueOrder.issuePiecesFormatted || '0'}}件</text>
      </view>
      <view class="grid-item">
        <image class="grid-icon" src="/images/icons/shirt.svg" mode="aspectFit"></image>
        <text class="grid-label">已回数量</text>
        <text class="grid-value highlight">{{issueOrder.progress.totalReturnPiecesFormatted || '0打0件'}} (共{{issueOrder.progress.totalReturnPieces}}件)</text>
      </view>
      <view class="grid-item">
        <image class="grid-icon" src="/images/icons/package.svg" mode="aspectFit"></image>
        <text class="grid-label">已回重量</text>
        <text class="grid-value">{{issueOrder.progress.totalReturnYarnFormatted || '0.00'}}kg</text>
      </view>
      <view class="grid-item">
        <image class="grid-icon" src="/images/icons/issue.svg" mode="aspectFit"></image>
        <text class="grid-label">剩余重量</text>
        <text class="grid-value unpaid">{{issueOrder.progress.remainingYarnFormatted || '0.00'}}kg</text>
      </view>
      <view class="grid-item">
        <image class="grid-icon" src="/images/icons/check.svg" mode="aspectFit"></image>
        <text class="grid-label">回货状态</text>
        <text class="grid-value">{{issueOrder.progress.status || '未回货'}}</text>
      </view>
    </view>
  </view>

  <!-- 款式信息卡片 -->
  <view class="section">
    <view class="card style-card">
      <view class="style-info-row">
        <view class="style-image-container" bindtap="onPreviewImage" data-url="{{issueOrder.styleImageUrl}}">
          <image class="style-image" src="{{issueOrder.styleImageUrl}}" mode="aspectFill" wx:if="{{issueOrder.styleImageUrl}}" binderror="onStyleImageError"></image>
          <view class="style-image-placeholder" wx:else>
            <image class="placeholder-icon" src="/images/icons/camera.svg" mode="aspectFit"></image>
          </view>
        </view>
        <view class="style-text-content">
          <view class="style-name-row">
            <text class="style-code" wx:if="{{issueOrder.styleCode}}">[{{issueOrder.styleCode}}]</text>
            <text class="style-name">{{issueOrder.styleName || '未知款号'}}</text>
          </view>
          <view class="style-meta-row">
            <text class="meta-item" wx:if="{{issueOrder.color}}">颜色: {{issueOrder.color}}</text>
            <text class="meta-item" wx:if="{{issueOrder.size}}">规格: {{issueOrder.size}}</text>
          </view>
          <view class="style-price-row">
            <text class="price-label">单件用量: </text>
            <text class="price-value">{{issueOrder.yarnUsagePerPieceFormatted || '0'}}g</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 回货记录列表 -->
  <view class="section" wx:if="{{issueOrder.returnOrders && issueOrder.returnOrders.length > 0}}">
    <view class="section-header">
      <text class="section-title">回货明细</text>
    </view>
    <view class="order-list">
      <view class="order-card card" wx:for="{{issueOrder.returnOrders}}" wx:key="_id">
        <view class="order-header">
          <view class="order-header-left">
            <image class="header-icon" src="/images/icons/calendar.svg" mode="aspectFit"></image>
            <text class="order-date">{{item.returnDateFormatted}}</text>
            <text class="status-badge settled">#{{item.returnOrderIndex}}</text>
          </view>
        </view>
        <view class="order-details-grid">
          <view class="detail-column">
            <text class="detail-label">回货重量</text>
            <text class="detail-value highlight">{{item.actualYarnUsageFormatted}}kg</text>
          </view>
          <view class="detail-column">
            <text class="detail-label">回货数量</text>
            <text class="detail-value highlight">{{item.quantityFormatted}}</text>
          </view>
          <view class="detail-column">
            <text class="detail-label">操作人</text>
            <text class="detail-value">{{item.operatorName || '系统管理员'}}</text>
          </view>
          <view class="detail-column">
            <text class="detail-label">颜色</text>
            <text class="detail-value">{{item.color || '-'}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <view class="empty-tip" wx:else>
    <text>暂无回货记录</text>
  </view>

  <!-- 悬浮分享按钮 -->
  <view class="fab-share-btn" bindtap="onShare">
    <image class="fab-icon" src="/images/icons/image.svg" mode="aspectFit" style="filter: brightness(0) invert(1);"></image>
    <text>生成分享图片</text>
  </view>

  <!-- 作废提示 -->
  <view class="voided-banner" wx:if="{{issueOrder.voided}}">
    <text>⚠️ 该发料单已作废</text>
  </view>

  <!-- 用于生成的画布 -->
  <canvas 
    canvas-id="shareCanvas" 
    style="position: fixed; top: -9999px; left: -9999px; width: {{canvasWidth}}px; height: {{canvasHeight}}px;"
    disable-scroll="true"
  ></canvas>
</view>

