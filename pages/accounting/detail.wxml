<!--pages/accounting/detail.wxml-->
<view class="container">
  <!-- 顶部蓝色背景区域 -->
  <view class="header-bg">
    <view class="header-content">
      <image class="header-icon" src="/images/icons/folder.svg" mode="aspectFit" style="filter: brightness(0) invert(1);"></image>
      <view class="header-text-group">
        <text class="header-title">{{factory.name || '加工厂'}}</text>
        <text class="header-subtitle">对账单明细</text>
      </view>
    </view>
    <view class="header-time">
      <image class="time-icon" src="/images/icons/calendar.svg" mode="aspectFit" style="filter: brightness(0) invert(1);"></image>
      <text class="time-text">生成时间: {{currentTime}}</text>
    </view>
  </view>

  <!-- 汇总统计网格 -->
  <view class="summary-grid-section">
    <view class="summary-grid">
      <view class="grid-item">
        <image class="grid-icon" src="/images/icons/wallet.svg" mode="aspectFit"></image>
        <text class="grid-label">总金额</text>
        <text class="grid-value">¥{{summaryFormatted.totalAmount}}</text>
      </view>
      <view class="grid-item">
        <image class="grid-icon" src="/images/icons/check-circle.svg" mode="aspectFit"></image>
        <text class="grid-label">已结算</text>
        <text class="grid-value">¥{{summaryFormatted.settledAmount}}</text>
      </view>
      <view class="grid-item">
        <image class="grid-icon" src="/images/icons/clock.svg" mode="aspectFit"></image>
        <text class="grid-label">未结算</text>
        <text class="grid-value unpaid">¥{{summaryFormatted.unpaidAmount}}</text>
      </view>
      <view class="grid-item">
        <image class="grid-icon" src="/images/icons/refresh.svg" mode="aspectFit"></image>
        <text class="grid-label">发毛数</text>
        <text class="grid-value">{{summaryFormatted.totalIssueWeight}}</text>
      </view>
      <view class="grid-item">
        <image class="grid-icon" src="/images/icons/package.svg" mode="aspectFit"></image>
        <text class="grid-label">回货重量</text>
        <text class="grid-value">{{summaryFormatted.totalReturnWeight}}</text>
      </view>
      <view class="grid-item">
        <image class="grid-icon" src="/images/icons/tag.svg" mode="aspectFit"></image>
        <text class="grid-label">回货数量</text>
        <text class="grid-value">{{summaryFormatted.totalReturnPieces}}</text>
      </view>
    </view>
  </view>

  <!-- 回货单列表 -->
  <view class="section">
    <view class="section-header">
      <text class="section-title">回货单明细</text>
    </view>
    <view class="order-list">
      <view 
        class="order-card card" 
        wx:for="{{returnOrders}}" 
        wx:key="_id"
        bindtap="onReturnOrderTap"
        data-id="{{item._id || item.id}}"
      >
        <view class="order-header">
          <view class="order-header-left">
            <image class="header-icon" src="/images/icons/calendar.svg" mode="aspectFit"></image>
            <text class="order-date">{{item.returnDateFormatted}}</text>
            <view class="status-badge" wx:if="{{item.unpaidAmount > 0}}">未结算</view>
            <view class="status-badge settled" wx:else>已结算</view>
          </view>
          <view class="order-header-right">
            <image class="style-image" src="{{item.styleImageUrl}}" mode="aspectFill" wx:if="{{item.styleImageUrl}}" catchtap="onPreviewImage" data-url="{{item.styleImageUrl}}"></image>
            <view class="style-image-placeholder" wx:else>
              <image class="placeholder-icon" src="/images/icons/camera.svg" mode="aspectFit"></image>
            </view>
          </view>
        </view>
        
        <view class="order-meta-row">
          <text class="operator-name">{{item.employeeName}}</text>
          <text class="style-code">{{item.styleCode ? '[' + item.styleCode + '] ' : ''}}{{item.styleName}}</text>
        </view>

        <view class="order-details-grid">
          <view class="detail-item">
            <image class="detail-icon" src="/images/icons/package.svg" mode="aspectFit"></image>
            <text class="detail-label">回货重量</text>
            <text class="detail-value highlight">{{item.returnWeightFormatted}}</text>
          </view>
          <view class="detail-item">
            <image class="detail-icon" src="/images/icons/tag.svg" mode="aspectFit"></image>
            <text class="detail-label">回货数量</text>
            <text class="detail-value">{{item.returnPiecesFormatted}}</text>
          </view>
          <view class="detail-item">
            <image class="detail-icon" src="/images/icons/refresh.svg" mode="aspectFit"></image>
            <text class="detail-label">发毛重量</text>
            <text class="detail-value">{{item.issueWeightFormatted}}</text>
          </view>
          <view class="detail-item">
            <image class="detail-icon" src="/images/icons/wallet.svg" mode="aspectFit"></image>
            <text class="detail-label">加工费</text>
            <text class="detail-value">¥{{item.processingFeeFormatted}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 结算记录 -->
  <view class="section" wx:if="{{settlements.length > 0}}">
    <view class="section-header">
      <text class="section-title">结算记录</text>
    </view>
    <view class="settlement-list">
      <view 
        class="settlement-card card" 
        wx:for="{{settlements}}" 
        wx:key="_id"
      >
        <view class="settlement-header">
          <text class="settlement-date">{{item.settlementDateFormatted}}</text>
          <text class="settlement-amount">¥{{item.totalAmountFormatted}}</text>
        </view>
        <text class="settlement-no" wx:if="{{item.settlementNo}}">单号：{{item.settlementNo}}</text>
      </view>
    </view>
  </view>

  <!-- 空状态 -->
  <view class="empty-tip" wx:if="{{returnOrders.length === 0 && !loading}}">
    <text>暂无回货单数据</text>
  </view>

  <!-- 加载中 -->
  <view class="loading-tip" wx:if="{{loading}}">
    <text>加载中...</text>
  </view>

  <!-- 悬浮分享按钮 -->
  <view class="fab-share-btn" bindtap="onShare">
    <image class="fab-icon" src="/images/icons/return.svg" mode="aspectFit" style="transform: rotate(180deg); filter: brightness(0) invert(1);"></image>
    <text class="fab-text">分享为图片</text>
  </view>

  <!-- 隐藏的画布用于生成分享图片 -->
  <canvas 
    canvas-id="shareCanvas" 
    style="position: fixed; top: -9999px; left: -9999px; width: 750px; height: 1600px;"
    disable-scroll="true"
  ></canvas>
</view>