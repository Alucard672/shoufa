<!--pages/factory/detail.wxml-->
<view class="container" wx:if="{{factory}}">
  <view class="factory-info card">
    <text class="factory-name">{{factory.name}}</text>
    <text class="factory-contact" wx:if="{{factory.contact}}">联系人：{{factory.contact}}</text>
    <text class="factory-phone" wx:if="{{factory.phone}}">联系方式：{{factory.phone}}</text>
    <text class="factory-price">加工单价：¥{{factory.defaultPrice}}/件</text>
    <text class="factory-settlement">结算方式：{{factory.settlementMethod}}</text>
  </view>

  <view class="stats-section">
    <view class="stat-card card">
      <text class="stat-label">累计发料</text>
      <text class="stat-value">{{totalIssueWeightFormatted}} kg</text>
    </view>
    <view class="stat-card card">
      <text class="stat-label">累计用纱</text>
      <text class="stat-value">{{totalUsedYarnFormatted}} kg</text>
    </view>
    <view class="stat-card card">
      <text class="stat-label">未结账款</text>
      <text class="stat-value fee">¥{{unpaidFeeFormatted}}</text>
    </view>
  </view>

  <!-- 结算按钮 -->
  <view class="settlement-section" wx:if="{{unpaidFee > 0}}">
    <view class="btn btn-primary btn-settlement-full" bindtap="navigateToSettlement">
      <text>去结算</text>
    </view>
  </view>

  <view class="tabs">
    <view class="tab-item {{currentTab === 0 ? 'active' : ''}}" data-index="0" bindtap="switchTab">发料记录</view>
    <view class="tab-item {{currentTab === 1 ? 'active' : ''}}" data-index="1" bindtap="switchTab">回货记录</view>
    <view class="tab-item {{currentTab === 2 ? 'active' : ''}}" data-index="2" bindtap="switchTab">结算记录</view>
  </view>

  <view class="section" wx:if="{{currentTab === 0}}">
    <view class="record-list">
      <view class="record-item" wx:for="{{issueOrders}}" wx:key="_id">
        <text class="record-text">{{item.styleName}} · {{item.issueWeight}}kg · {{item.issueDateFormatted}}</text>
      </view>
      <view class="empty-tip" wx:if="{{issueOrders.length === 0}}">
        <text>暂无发料记录</text>
      </view>
    </view>
  </view>

  <view class="section" wx:if="{{currentTab === 1}}">
    <view class="record-list">
      <view class="record-item" wx:for="{{returnOrders}}" wx:key="_id">
        <text class="record-text">{{item.styleName}} · {{item.returnQuantity}}打 · ¥{{item.processingFeeFormatted}} · {{item.returnDateFormatted}}</text>
      </view>
      <view class="empty-tip" wx:if="{{returnOrders.length === 0}}">
        <text>暂无回货记录</text>
      </view>
    </view>
  </view>

  <view class="section" wx:if="{{currentTab === 2}}">
    <view class="record-list">
      <view class="record-item" wx:for="{{settlements}}" wx:key="_id">
        <view class="settlement-row">
          <text class="settlement-no">{{item.settlementNo}}</text>
          <text class="settlement-amount">¥{{item.totalAmountFormatted}}</text>
        </view>
        <view class="settlement-row">
          <text class="settlement-date">{{item.settlementDateFormatted}}</text>
        </view>
        <view class="settlement-row" wx:if="{{item.remark}}">
          <text class="settlement-remark">备注：{{item.remark}}</text>
        </view>
      </view>
      <view class="empty-tip" wx:if="{{settlements.length === 0}}">
        <text>暂无结算记录</text>
      </view>
    </view>
  </view>
</view>
