# MySQL数据库迁移指南（腾讯云开发RDB）

## 概述

本项目使用腾讯云开发的RDB（关系型数据库）服务，通过云函数操作MySQL数据库。所有数据库操作现在通过云函数进行。

## 前置要求

1. **腾讯云开发环境**
   - 已开通云开发服务
   - 已创建RDB数据库实例
   - 云开发环境ID：`cloud1-3g9cra4h71f647dd`

2. **云函数环境**
   - 微信云开发环境
   - Node.js 运行环境

## 数据库配置

### 1. 创建RDB数据库实例

1. 登录腾讯云开发控制台
2. 进入"数据库" -> "关系型数据库"
3. 创建MySQL数据库实例（如果还没有）
4. 记录实例名称（默认：`default`）

### 2. 创建数据库表结构

在RDB数据库中执行 `database/mysql_schema.sql` 文件创建表结构：

**方法一：通过云开发控制台**
1. 进入"数据库" -> "关系型数据库"
2. 选择数据库实例
3. 点击"SQL执行"
4. 复制 `database/mysql_schema.sql` 的内容
5. 执行SQL语句

**方法二：通过云函数执行**
可以创建一个初始化云函数来执行SQL文件（需要手动执行SQL语句）

### 3. 部署云函数

1. 右键点击 `cloudfunctions/mysql` 文件夹
2. 选择"上传并部署：云端安装依赖"
3. 等待部署完成

**注意**：云函数会自动使用当前云开发环境的RDB实例，无需配置连接信息。

## 代码变更说明

### 数据库操作方式变更

**之前（云数据库）：**
```javascript
const db = wx.cloud.database()
const result = await db.collection('styles').where({...}).get()
```

**现在（MySQL RDB）：**
```javascript
import { getStyles } from '../../utils/db.js'
const result = await getStyles()
```

### 主要变更

1. **所有数据库操作**：从直接调用云数据库改为调用云函数
2. **字段命名**：自动处理驼峰和下划线命名转换
3. **ID字段**：`_id` 自动转换为 `id`，查询结果自动添加 `_id` 字段
4. **租户隔离**：所有操作自动添加 `tenant_id` 条件

## 表结构说明

### 主要表

1. **tenants** - 租户表
2. **users** - 用户表
3. **styles** - 款号表
4. **factories** - 加工厂表
5. **yarn_inventory** - 纱线库存表
6. **production_plans** - 生产计划单表
7. **issue_orders** - 发料单表
8. **return_orders** - 回货单表
9. **settlements** - 结算表
10. **color_dict** - 颜色字典表
11. **size_dict** - 尺码字典表

### 字段命名规则

- 数据库字段：下划线命名（如 `style_code`, `create_time`）
- JavaScript对象：驼峰命名（如 `styleCode`, `createTime`）
- 自动转换：云函数自动处理命名转换

## 注意事项

1. **RDB实例**：使用腾讯云开发提供的RDB服务，无需自己搭建MySQL服务器
2. **连接管理**：RDB自动管理连接，无需手动创建连接池
3. **事务支持**：支持事务操作，确保数据一致性
4. **软删除**：所有表都有 `deleted` 字段，默认值为0（未删除）
5. **时间戳**：`create_time` 和 `update_time` 自动管理
6. **租户隔离**：所有查询自动添加 `tenant_id` 条件

## 性能优化

1. **索引**：已为常用查询字段创建索引
2. **查询优化**：避免全表扫描，使用索引字段查询
3. **连接管理**：RDB自动管理连接，无需担心连接池问题

## 故障排查

### 常见问题

1. **RDB实例不存在**
   - 检查是否已创建RDB数据库实例
   - 检查实例名称是否正确（默认：`default`）

2. **表不存在**
   - 检查是否已执行SQL文件创建表结构
   - 检查表名是否正确

3. **权限错误**
   - 检查云函数是否有权限访问RDB
   - 检查数据库用户权限

4. **字段不存在**
   - 检查表结构是否与SQL文件一致
   - 检查字段命名是否正确

## 优势

相比自建MySQL服务器：

1. **无需配置**：无需配置MySQL连接信息
2. **自动管理**：连接、事务等自动管理
3. **高可用**：腾讯云提供高可用保障
4. **安全**：数据存储在腾讯云，安全可靠
5. **易用**：使用类似Knex.js的查询构建器，易于使用

## 后续优化建议

1. **索引优化**：根据实际查询情况优化索引
2. **查询优化**：优化慢查询，提升性能
3. **监控**：使用云开发监控功能，及时发现性能问题
4. **备份**：定期备份数据库，确保数据安全
