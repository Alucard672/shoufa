# 如何创建数据库索引

## 方法一：通过云开发控制台手动创建（推荐）

### 步骤详解

1. **打开微信开发者工具**
   - 启动你的小程序项目

2. **进入云开发控制台**
   - 点击顶部菜单栏的"云开发"按钮
   - 如果没有看到"云开发"按钮，需要先开通云开发服务

3. **进入数据库管理**
   - 在云开发控制台中，点击左侧菜单的"数据库"
   - 或者直接点击顶部标签页的"数据库"

4. **选择集合**
   - 在左侧集合列表中，找到需要创建索引的集合（如：`return_orders`）
   - 点击集合名称

5. **进入索引管理**
   - 点击集合详情页顶部的"索引管理"标签
   - 如果没有看到"索引管理"，可能需要先切换到"数据"标签，然后再切换回来

6. **添加索引**
   - 点击"添加索引"按钮
   - 在弹出的对话框中：
     - **第一个字段**：输入 `deleted`，排序方式选择"升序"
     - **第二个字段**：输入 `issueId`，排序方式选择"升序"
     - 点击"确定"创建

7. **等待索引创建完成**
   - 索引创建可能需要几分钟时间
   - 创建完成后，索引会显示在索引列表中
   - 状态会从"创建中"变为"正常"

---

## 方法二：使用快速创建链接

### 什么是快速创建链接？

快速创建链接是云开发控制台提供的一种快捷方式，可以直接跳转到索引创建页面并预填索引配置。

### 如何使用？

#### 方式A：在控制台日志中点击（最简单）

1. **查看控制台日志**
   - 在微信开发者工具中，打开"调试器"或"控制台"
   - 找到包含"快速创建索引链接"的日志信息
   - 日志格式类似：
     ```
     快速创建索引链接：cloud://createindex?env=...
     ```

2. **点击链接**
   - 直接点击日志中的链接
   - 会自动跳转到云开发控制台的索引创建页面
   - 索引配置会自动填充

3. **确认创建**
   - 检查索引配置是否正确
   - 点击"确定"创建索引

#### 方式B：复制链接到浏览器

1. **复制链接**
   - 从文档或日志中复制完整的快速创建链接
   - 例如：
     ```
     cloud://createindex?env=cloud1-3g9cra4h71f647dd&collection=return_orders&from=console&s=%5B%7B%22field%22%3A%22deleted%22%2C%22type%22%3A1%7D%2C%7B%22field%22%3A%22issueId%22%2C%22type%22%3A1%7D%5D
     ```

2. **打开浏览器**
   - 打开 Chrome 或其他浏览器
   - **重要**：需要先登录微信开发者工具，并打开云开发控制台
   - 在浏览器地址栏中，将链接粘贴进去
   - 按回车键访问

3. **如果无法访问**
   - 链接可能需要在微信开发者工具的内置浏览器中打开
   - 或者使用方式A（在控制台日志中点击）

---

## 方法三：手动解析链接参数创建

如果快速创建链接无法使用，可以手动解析链接中的参数，然后手动创建索引。

### 链接参数解析

示例链接：
```
cloud://createindex?env=cloud1-3g9cra4h71f647dd&collection=return_orders&from=console&s=%5B%7B%22field%22%3A%22deleted%22%2C%22type%22%3A1%7D%2C%7B%22field%22%3A%22issueId%22%2C%22type%22%3A1%7D%5D
```

参数说明：
- `env=cloud1-3g9cra4h71f647dd`：云开发环境ID
- `collection=return_orders`：集合名称
- `s=...`：索引字段配置（URL编码的JSON）

### 解码索引字段

将 `s` 参数的值进行 URL 解码，得到：
```json
[
  {"field":"deleted","type":1},
  {"field":"issueId","type":1}
]
```

字段说明：
- `field`: 字段名称
- `type`: 排序方式
  - `1` = 升序（asc）
  - `-1` = 降序（desc）

### 手动创建步骤

1. 按照"方法一"的步骤，进入索引管理页面
2. 点击"添加索引"
3. 根据解码后的配置，手动输入：
   - 第一个字段：`deleted`，升序
   - 第二个字段：`issueId`，升序
4. 点击"确定"创建

---

## 常见问题

### Q1: 点击链接没有反应？

**解决方案**：
- 确保已经登录微信开发者工具
- 确保已经开通云开发服务
- 尝试使用"方法一"手动创建
- 检查链接是否完整（没有截断）

### Q2: 链接在浏览器中无法打开？

**解决方案**：
- `cloud://` 协议链接需要在微信开发者工具的内置浏览器中打开
- 或者使用"方法一"手动创建
- 或者复制链接参数，手动在控制台创建

### Q3: 索引创建失败？

**可能原因**：
- 字段名称拼写错误
- 字段不存在于集合中
- 索引已存在
- 索引数量超过限制（每个集合最多20个）

**解决方案**：
- 检查字段名称是否正确
- 检查集合中是否存在该字段
- 检查索引列表中是否已存在相同索引
- 删除不需要的索引后再创建

### Q4: 如何验证索引是否创建成功？

**验证方法**：
1. 在索引管理页面，查看索引列表
2. 索引状态应该显示为"正常"
3. 运行查询，查看是否还有全表扫描警告
4. 在云开发控制台的"统计"页面，查看查询耗时是否降低

### Q5: 索引创建需要多长时间？

**时间说明**：
- 小数据量（< 1万条）：通常几秒钟
- 中等数据量（1-10万条）：可能需要1-5分钟
- 大数据量（> 10万条）：可能需要5-30分钟

**注意事项**：
- 索引创建期间，查询性能可能略有下降
- 建议在业务低峰期创建索引
- 创建完成后，查询性能会显著提升

---

## 推荐创建顺序

根据优先级，建议按以下顺序创建索引：

### 第一批（立即创建）
1. `return_orders`: idx_deleted_issueId
2. `issue_orders`: idx_deleted_issueDate
3. `return_orders`: idx_deleted_returnDate
4. `styles`: idx_deleted
5. `factories`: idx_deleted
6. `issue_orders`: idx_deleted

### 第二批（尽快创建）
7. `return_orders`: idx_deleted_settlementStatus

### 第三批（可选）
8-13. 其他优化索引

---

## 索引创建检查清单

创建完成后，请在此清单中打勾确认：

### ⚠️ 最高优先级
- [ ] `return_orders`: idx_deleted_issueId
- [ ] `issue_orders`: idx_deleted_issueDate
- [ ] `return_orders`: idx_deleted_returnDate
- [ ] `styles`: idx_deleted
- [ ] `factories`: idx_deleted
- [ ] `issue_orders`: idx_deleted

### 📌 第二批
- [ ] `return_orders`: idx_deleted_settlementStatus

---

**最后更新**: 2025-12-19


