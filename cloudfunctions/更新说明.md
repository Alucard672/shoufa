# 云函数更新说明

## 重要更新

**createIssueOrder 云函数已更新，新增了自动扣减纱线库存功能！**

### 更新内容

1. **自动扣减纱线库存**
   - 创建发料单时，如果款号关联了纱线，会自动扣减对应纱线的库存
   - 支持多个纱线按库存比例分配扣减量
   - 库存不足时会阻止创建发料单并提示错误

2. **事务保证**
   - 使用数据库事务确保库存扣减和发料单创建的原子性
   - 如果任何一步失败，整个操作会回滚

### 需要重新上传的云函数

**必须重新上传 `createIssueOrder` 云函数才能使用新功能！**

## 上传步骤

### 方法一：通过微信开发者工具上传

1. 在微信开发者工具中，找到 `cloudfunctions/createIssueOrder` 文件夹
2. 右键点击该文件夹
3. 选择 **"上传并部署：云端安装依赖"** 或 **"上传并部署：全量文件"**
4. 等待上传完成（首次上传可能需要几分钟安装依赖）

### 方法二：通过云开发控制台上传

1. 登录微信公众平台
2. 进入"云开发"控制台
3. 选择"云函数"
4. 找到 `createIssueOrder` 函数
5. 点击"上传代码"
6. 选择本地代码文件上传

## 验证更新

上传完成后，可以通过以下方式验证：

1. **查看云函数代码**：在云开发控制台查看函数代码，确认包含库存扣减逻辑
2. **测试调用**：创建一个关联了纱线的款号，然后创建发料单，检查库存是否被扣减
3. **查看日志**：在云函数日志中查看是否有错误信息

## 注意事项

1. **数据备份**：上传前建议备份现有数据
2. **测试环境**：建议先在测试环境验证功能正常
3. **错误处理**：如果上传失败，检查网络连接和云开发环境状态
4. **版本管理**：上传后会覆盖之前的版本，请确保代码正确

## 功能说明

### 库存扣减规则

- **单个纱线**：如果款号只关联一个纱线，全部发料重量从该纱线扣减
- **多个纱线**：如果款号关联多个纱线，按各纱线库存比例分配扣减量
  - 例如：纱线A库存100kg，纱线B库存200kg，发料80kg
  - 纱线A扣减：80 × (100/300) = 26.67kg
  - 纱线B扣减：80 × (200/300) = 53.33kg

### 错误处理

- 如果关联的纱线不存在或已删除，会提示错误
- 如果库存不足，会显示具体哪个纱线库存不足及需要扣减的数量
- 所有错误都会阻止发料单创建，确保数据一致性

## 回滚说明

如果新版本有问题，可以：
1. 在云开发控制台查看之前的版本
2. 恢复到之前的版本
3. 或者手动修改代码后重新上传

